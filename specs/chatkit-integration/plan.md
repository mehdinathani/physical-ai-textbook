# Implementation Plan: ChatKit Integration

**Branch**: `feature/chatkit-integration` | **Date**: 2025-12-25
**Status**: Updated with clarifications
**Input**: Fix ChatKit integration using chatkit skills (frontend + backend on port 8001)

## Summary

Replace broken ChatWidget.tsx (React Hooks violations) and backend-chatkit (port conflict, broken) with fresh ChatKit implementation using official skills. Previous attempts (commits 6b51226 → 3c0ee65) failed due to SSR incompatibility and React Hooks violations.

**Key Clarifications Applied:**
- Q1: ChatKit backend on port 8001 (separate from RAG backend on 8000)
- Q2: Use `chatkit.quickstart` skill for fresh frontend
- Q3: Use `chatkit.backend` skill for fresh backend

**Key Objectives:**
- Generate fresh ChatKit frontend via `chatkit.quickstart` skill
- Generate fresh ChatKit backend via `chatkit.backend` skill on port 8001
- Ensure SSR compatibility with Docusaurus (BrowserOnly pattern)
- Implement thread persistence via localStorage
- Enable real-time streaming responses with SSE
- Follow React Hooks Rules (hooks called unconditionally, conditional rendering only)

## Technical Context

**Language/Version**: Python 3.11+ (backend), TypeScript/React 18 (frontend)
**Primary Dependencies**:
- Backend: FastAPI, openai-chatkit, openai-agents[litellm]
- Frontend: @openai/chatkit-react, React, Docusaurus 3.1.0
**Storage**: In-memory store (backend), localStorage (frontend thread IDs)
**Testing**: Manual testing protocol (SSR build, chat functionality, thread persistence)
**Target Platform**:
- Backend: Local development (port 8001), future: Render.com
- Frontend: Vercel (Docusaurus static site with SSR)
**Project Type**: Web application (React frontend + FastAPI backend)
**Performance Goals**: <2s response latency, real-time streaming, thread continuity across sessions
**Constraints**:
- CRITICAL: SSR compatibility (Docusaurus build must succeed)
- Python 3.11+ required (protobuf issues with 3.14)
- ChatKit backend must run on port 8001 (RAG backend uses 8000)
**Scale/Scope**: Educational platform, moderate traffic (~1000 students)

## Project Structure

### Documentation (this feature)
```text
specs/chatkit-integration/
├── plan.md              # This implementation plan
├── tasks.md             # Generated by /sp.tasks command (next step)
└── research.md          # Skill-generated artifacts
```

### Source Code (repository root)
```text
# Dual backend structure (RAG + ChatKit)
backend/                      # Existing RAG backend (unchanged, port 8000)
├── main.py
├── ingest.py
└── requirements.txt

backend-chatkit/              # NEW: ChatKit Server backend (port 8001)
├── main.py                   # Generated by chatkit.backend skill
├── requirements.txt
├── .env.example
└── .python-version

frontend/
├── src/
│   ├── components/
│   │   └── ChatWidget.tsx    # REPLACED: Generated by chatkit.quickstart skill
│   └── theme/
│       └── Root.tsx          # MODIFY: Update to load ChatWidget correctly
└── docusaurus.config.ts
```

**Structure Decision**: Web application with dual backends. Existing RAG backend (port 8000) remains for content transformation. New ChatKit backend (port 8001) handles chat. Frontend uses fresh ChatKit implementation generated by skills.

## Constitution Check

**Status**: PASS - No constitution violations.

This implementation follows:
- **Spec-Driven Execution**: Changes trace to specs/chatkit-integration/spec.md
- **Bilingual Excellence**: TypeScript frontend, Python backend, clear separation
- **Agent & Skill Discovery**: Using chatkit.quickstart and chatkit.backend skills
- **Hackathon Velocity**: Using proven skill implementations vs manual coding
- **AI-Native First**: ChatKit natively integrates with OpenAI Agents SDK
- **Clean UX**: ChatKit provides production-grade UI
- **Performance Efficiency**: <2s latency via streaming responses

## Implementation Strategy

### Phase 0: Skill Execution (Frontend + Backend)

#### 0.1 Generate Frontend via chatkit.quickstart
**Command**: `/chatkit.quickstart`

**Generated Output Expected**:
- Fresh ChatWidget component (React Hooks compliant)
- SSR-safe implementation patterns
- Proper localStorage handling
- ChatKit React SDK integration
- Floating button + modal UI pattern

**Post-Generation Tasks**:
1. Copy generated ChatWidget.tsx to `frontend/src/components/ChatWidget.tsx`
2. Update ChatWidget configuration:
   - API URL: `http://localhost:8001/chatkit`
   - Domain key: `physai`
   - Theme: Dark with Docusaurus blue accent
3. Verify SSR compatibility (hooks called unconditionally)

#### 0.2 Generate Backend via chatkit.backend
**Command**: `/chatkit.backend`

**Generated Output Expected**:
- FastAPI ChatKit server implementation
- OpenAI Agents SDK integration with Gemini
- In-memory thread store
- CORS configuration for localhost:3000 and vercel.app

**Post-Generation Tasks**:
1. Copy generated backend to `backend-chatkit/` directory
2. Update server port to **8001** (critical - avoids conflict with RAG backend on 8000)
3. Update assistant instructions for Physical AI context
4. Verify `/health` and `/debug/threads` endpoints

### Phase 1: Frontend Integration

#### 1.1 Update Root.tsx
**File**: `frontend/src/theme/Root.tsx`

**Actions**:
1. Ensure ChatWidget import is correct:
   ```tsx
   import ChatWidget from '@site/src/components/ChatWidget';
   ```
2. Keep existing BrowserOnly wrapper (SSR-safe)
3. Keep existing ChatKit CDN script in Head:
   ```tsx
   <script
     src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"
     async
   />
   ```

#### 1.2 Environment Configuration
**File**: `frontend/.env.local` (create if needed)

**Content**:
```bash
VITE_CHATKIT_BACKEND_URL=http://localhost:8001/chatkit
```

**Note**: ChatWidget should use this env var or default to localhost:8001

#### 1.3 Git Ignore
**File**: `.gitignore`

**Add if missing**:
```
frontend/.env.local
backend-chatkit/.env
backend-chatkit/venv/
backend-chatkit/__pycache__/
```

### Phase 2: Backend Configuration

#### 2.1 Backend Environment
**File**: `backend-chatkit/.env.example`

**Content**:
```bash
GEMINI_API_KEY=your_gemini_api_key_here
PORT=8001
```

#### 2.2 Backend Requirements
**File**: `backend-chatkit/requirements.txt`

**Expected content** (from skill):
```text
fastapi>=0.115.0
uvicorn[standard]>=0.32.0
openai-chatkit>=1.0.0
openai-agents[litellm]>=0.6.0
python-dotenv>=1.0.0
```

### Phase 3: Testing Strategy

#### 3.1 Start ChatKit Backend
**Commands**:
```bash
cd backend-chatkit
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
set GEMINI_API_KEY=your_key
python main.py
```

**Expected Output**:
```
INFO:     Started server process [1]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8001
```

#### 3.2 Start Frontend
**Commands**:
```bash
cd frontend
npm start
```

#### 3.3 Critical Tests

1. **SSR Build Test**: `npm run build` must succeed without "window is not defined" errors
2. **Port Verification**:
   - RAG backend accessible on `http://localhost:8000`
   - ChatKit backend accessible on `http://localhost:8001`
3. **Chat Functionality**: Send message, receive streaming response
4. **Thread Persistence**: Refresh page, messages should persist via localStorage
5. **New Chat**: Button clears localStorage and creates fresh thread
6. **React Hooks Compliance**: No "Invariant Violation: Do not call Hooks inside" errors
7. **Mobile Responsiveness**: Chat widget works on screens < 600px

### Phase 4: Deployment (When Ready)

#### 4.1 Backend Deployment (Future)
**Target**: Render.com or similar service
**Environment Variables**:
- `GEMINI_API_KEY`: Gemini API key
- `PORT`: 8001

#### 4.2 Frontend Deployment (Future)
**Vercel Environment Variable**:
- `VITE_CHATKIT_BACKEND_URL`: Production ChatKit backend URL

## Critical Files

### Files to CREATE (via skills):
1. `frontend/src/components/ChatWidget.tsx` - Generated by chatkit.quickstart skill
2. `backend-chatkit/main.py` - Generated by chatkit.backend skill
3. `backend-chatkit/requirements.txt` - Generated by skill
4. `backend-chatkit/.env.example` - Create manually
5. `frontend/.env.local` - Create manually

### Files to MODIFY:
1. `frontend/src/theme/Root.tsx` - Update ChatWidget import if needed
2. `.gitignore` - Add backend-chatkit exclusions if missing

### Files to DELETE:
1. `frontend/src/components/SimpleChatWidget.tsx` - Not needed with ChatKit
2. Consider: Delete old `backend-chatkit/` before regenerating

## Risk Mitigation

### Risk 1: SSR Incompatibility (CRITICAL)
**Previous Failure**: Commits 6b51226 → 3c0ee65 show ChatKit broke SSR build
**Current Approach**: Using `chatkit.quickstart` skill which generates SSR-compliant code
**Mitigation**:
- Skill-generated code follows ChatKit best practices
- BrowserOnly wrapper already in Root.tsx
- Test `npm run build` after changes

### Risk 2: Port Conflict
**Issue**: RAG backend uses port 8000
**Mitigation**: ChatKit backend configured for port 8001 (per clarification)

### Risk 3: React Hooks Violations
**Issue**: Previous ChatWidget called `useChatKit` conditionally
**Mitigation**: Skill-generated code follows React Hooks Rules (hooks called unconditionally)

### Risk 4: Frontend-Backend Version Mismatch
**Issue**: ChatKit React SDK and ChatKit Server must be compatible versions
**Mitigation**: Using both skills ensures aligned versions

### Risk 5: Environment Variables Not Loading
**Issue**: Vite requires `VITE_` prefix for client-side env vars
**Mitigation**: Ensure `VITE_CHATKIT_BACKEND_URL` is used in .env.local

## Rollback Strategy

**Frontend Rollback**:
```bash
git revert <commit-hash>
git push origin main
```
Vercel redeploys in ~2 min

**Backend Rollback**:
- Keep existing RAG backend running on port 8000
- Stop new ChatKit backend service

## Success Criteria

- [ ] ChatKit backend runs locally on port 8001
- [ ] Frontend builds successfully (`npm run build` succeeds)
- [ ] Chat widget displays floating button
- [ ] Messages send and stream in real-time
- [ ] Thread persists across page reloads via localStorage
- [ ] "New Chat" button creates fresh thread
- [ ] No browser console errors (React Hooks, SSR)
- [ ] No React Hooks violations
- [ ] Mobile responsive (test on small viewport)
- [ ] Both backends can run simultaneously (8000 + 8001)

## Next Steps

1. **Execute `/chatkit.quickstart`** - Generate fresh frontend ChatKit component
2. **Execute `/chatkit.backend`** - Generate fresh backend on port 8001
3. **Run `/sp.tasks`** - Generate actionable task list
4. **Run `/sp.implement`** - Execute the implementation
5. **Deploy and test** - Verify all success criteria

## Skill Dependencies

The following skills will be used for implementation:
- `chatkit.quickstart` - Generates React frontend with ChatKit integration
- `chatkit.backend` - Generates FastAPI backend with ChatKit Server protocol
- `chatkit.debug` - Available if issues arise during testing
